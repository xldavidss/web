<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard de Fichaje y Reportes</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <style>
    body { background-color: #f4f6f8; font-family: 'Inter', sans-serif; }
    .navbar { background-color: #0d6efd; }
    .navbar-brand, .nav-link, .text-light { color: white !important; }
    .card { border-radius: 1rem; box-shadow: 0 3px 8px rgba(0,0,0,0.1); }
    .btn-primary { background-color: #0d6efd; border: none; }
    .btn-primary:hover { background-color: #0b5ed7; }
    #map { height: 200px; border-radius: 0.75rem; }
    .funny-text { font-style: italic; font-size: 0.9rem; color: #6c757d; }
    .modal-content { border-radius: 1rem; }
    #status-indicator { font-weight: 600; border-radius: 0.5rem; padding: 10px; }
    #user-photo { cursor: pointer; transition: transform 0.2s; }
    #user-photo:hover { transform: scale(1.1); }
  </style>
</head>
<body>

<input type="file" id="avatar-upload-input" accept="image/*" style="display: none;">

<nav class="navbar navbar-expand-lg navbar-dark shadow-sm">
  <div class="container">
    <a class="navbar-brand d-flex align-items-center" href="#">
      <i class="bi bi-clipboard-check me-2"></i> Dashboard de Empleado
    </a>
    <div class="ms-auto d-flex align-items-center">
      <span id="user-name" class="me-3 fw-semibold d-none d-sm-block">Cargando...</span>
      <img id="user-photo" src="https://placehold.co/40x40/0d6efd/FFFFFF?text=üôÇ" alt="Foto" class="rounded-circle border border-light me-3" width="40" height="40" title="Haz clic para cambiar tu foto">
      <button id="logout-btn" class="btn btn-outline-light btn-sm">Cerrar Sesi√≥n</button>
    </div>
  </div>
</nav>

<main class="container my-5">
  <div class="row g-4">
    <div class="col-lg-4">
      <div class="card p-4 mb-4">
        <h5 class="fw-bold mb-3"><i class="bi bi-clock-history text-primary me-2"></i>Control de Asistencia</h5>
        <p id="current-time" class="display-6 fw-bold text-primary text-center">--:--:--</p>
        <p id="current-date" class="text-center text-muted mb-3">Cargando fecha...</p>
        <div id="status-indicator" class="bg-light text-center mb-3">Estado: Fuera de la oficina üèñÔ∏è</div>
        <button id="clock-in-btn" class="btn btn-primary w-100 py-2">Registrar Entrada Manual</button>
        <p class="funny-text text-center mt-3">üí° Consejo: el caf√© cuenta como combustible laboral ‚òï</p>
      </div>
      <div class="card p-4 mb-4">
        <h5 class="fw-bold mb-3"><i class="bi bi-geo-alt text-danger me-2"></i>Control Autom√°tico (GPS)</h5>
        <div class="form-check form-switch mb-3">
          <input class="form-check-input" type="checkbox" id="auto-toggle">
          <label class="form-check-label fw-semibold" for="auto-toggle">Modo autom√°tico (Salida)</label>
        </div>
        <div id="map" class="mb-2"></div>
        <p id="location-status" class="text-center text-muted">El modo autom√°tico est√° desactivado.</p>
      </div>
      <div class="card p-4">
        <h5 class="fw-bold mb-3"><i class="bi bi-list-check text-success me-2"></i>Actividad Reciente</h5>
        <ul id="activity-log" class="list-unstyled small text-muted">
          <li class="fst-italic text-center">No hay actividad hoy... a√∫n üí§</li>
        </ul>
      </div>
    </div>

    <div class="col-lg-8">
      <div class="card p-4">
        <h5 class="fw-bold mb-3"><i class="bi bi-journal-text text-info me-2"></i>Subir Reporte Diario</h5>
        <p class="text-muted mb-3">Detalla tus actividades y adjunta hasta 5 im√°genes como evidencia.</p>
        <form id="report-form">
            <textarea name="reportText" id="report-text" rows="6" class="form-control mb-3" placeholder="Escribe tu reporte aqu√≠..."></textarea>
            <label class="form-label fw-semibold">Adjuntar im√°genes (m√°x. 5):</label>
            <input name="reportImages" id="image-upload" type="file" multiple accept="image/*" class="form-control mb-3">
            <div id="image-preview-container" class="d-flex flex-wrap gap-2 mb-3"></div>
            <div class="text-end">
              <button id="submit-report-btn" type="submit" class="btn btn-primary px-4"><i class="bi bi-send-fill me-2"></i>Enviar Reporte</button>
            </div>
        </form>
      </div>
    </div>
  </div>
</main>

<div class="modal fade" id="customModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content text-center p-4">
      <h5 id="modal-title" class="fw-bold mb-3"></h5>
      <p id="modal-message" class="text-muted mb-4"></p>
      <button type="button" class="btn btn-primary px-4" data-bs-dismiss="modal">Entendido</button>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async function () {
  const API_URL = 'http://localhost:3000';
  const token = localStorage.getItem('authToken');
  if (!token) {
    window.location.href = './logueo.html';
    return;
  }
  
  // Elementos del DOM
  const userNameEl = document.getElementById('user-name');
  const userPhotoEl = document.getElementById('user-photo');
  const avatarUploadInput = document.getElementById('avatar-upload-input');
  const imageUpload = document.getElementById('image-upload');
  const imagePreviewContainer = document.getElementById('image-preview-container');
  const reportForm = document.getElementById('report-form');
  const modal = new bootstrap.Modal(document.getElementById('customModal'));
  const modalTitle = document.getElementById('modal-title');
  const modalMessage = document.getElementById('modal-message');
  const activityLog = document.getElementById('activity-log');

  function showModal(title, msg) {
    modalTitle.textContent = title;
    modalMessage.textContent = msg;
    modal.show();
  }

  // --- Cargar datos del usuario ---
  try {
    const response = await fetch(`${API_URL}/api/user`, {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    if (!response.ok) throw new Error('No se pudo cargar la informaci√≥n del usuario.');
    
    const user = await response.json();
    userNameEl.textContent = user.name;
    if (user.avatar_url) {
      userPhotoEl.src = `${API_URL}${user.avatar_url}`;
    }
  } catch (error) {
    userNameEl.textContent = 'Error';
    console.error(error.message);
  }

  // --- Cerrar sesi√≥n ---
  document.getElementById('logout-btn').addEventListener('click', () => {
    localStorage.removeItem('authToken');
    window.location.href = './logueo.html';
  });

  // --- Subir foto de perfil ---
  userPhotoEl.addEventListener('click', () => avatarUploadInput.click());
  avatarUploadInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    const formData = new FormData();
    formData.append('avatar', file);

    try {
      const response = await fetch(`${API_URL}/api/upload-avatar`, {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}` },
        body: formData
      });
      const result = await response.json();
      if (!response.ok) throw new Error(result.message);
      
      userPhotoEl.src = `${API_URL}${result.avatar_url}`; // Actualizar la imagen
      showModal('√âxito', result.message);
      logActivity('Foto de perfil actualizada', 'üì∏');

    } catch (error) {
      showModal('Error al subir', error.message);
    }
  });

  // --- L√≥gica de reporte ---
  imageUpload.addEventListener('change', e => {
    imagePreviewContainer.innerHTML = '';
    if (e.target.files.length > 5) {
        showModal('L√≠mite excedido', 'Solo puedes subir un m√°ximo de 5 im√°genes.');
        imageUpload.value = ''; // Limpiar la selecci√≥n
        return;
    }
    for (const file of e.target.files) {
      const reader = new FileReader();
      reader.onload = ev => {
        imagePreviewContainer.insertAdjacentHTML('beforeend', `<img src="${ev.target.result}" class="rounded" style="width:80px;height:80px;object-fit:cover;">`);
      };
      reader.readAsDataURL(file);
    }
  });

  reportForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const submitBtn = document.getElementById('submit-report-btn');
    const originalBtnText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = `<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Enviando...`;

    const formData = new FormData(reportForm);
    if (!formData.get('reportText').trim()) {
        showModal('Campo vac√≠o', 'El reporte no puede estar vac√≠o.');
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
        return;
    }

    try {
        const response = await fetch(`${API_URL}/api/submit-report`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${token}` },
            body: formData
        });
        const result = await response.json();
        if (!response.ok) throw new Error(result.message);
        
        showModal('√âxito', result.message);
        logActivity('Reporte diario enviado', 'üìù');
        reportForm.reset();
        imagePreviewContainer.innerHTML = '';
    } catch (error) {
        showModal('Error en el env√≠o', error.message);
    } finally {
        submitBtn.disabled = false;
        submitBtn.innerHTML = originalBtnText;
    }
  });

  // --- Resto de la l√≥gica (reloj, mapa, etc. sin cambios) ---
  const officeCoords = { lat: 4.60971, lon: -74.08175 };
  const workRadius = 1000;
  const currentTimeEl = document.getElementById('current-time');
  const currentDateEl = document.getElementById('current-date');
  const statusIndicator = document.getElementById('status-indicator');
  const clockInBtn = document.getElementById('clock-in-btn');
  const locationStatus = document.getElementById('location-status');
  
  function updateTime() {
    const now = new Date();
    currentTimeEl.textContent = now.toLocaleTimeString('es-CO');
    currentDateEl.textContent = now.toLocaleDateString('es-CO', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
  }
  setInterval(updateTime, 1000);
  updateTime();

  const map = L.map('map').setView([officeCoords.lat, officeCoords.lon], 13);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
  L.marker([officeCoords.lat, officeCoords.lon]).addTo(map).bindPopup('Oficina Principal üè¢');
  L.circle([officeCoords.lat, officeCoords.lon], { radius: workRadius, color: '#0d6efd', fillOpacity: 0.2 }).addTo(map);

  let userMarker, isWithinZone = false;
  
  function logActivity(msg, icon = 'üóÇÔ∏è') {
    if (activityLog.querySelector('.fst-italic')) activityLog.innerHTML = '';
    const time = new Date().toLocaleTimeString('es-CO', { hour: '2-digit', minute: '2-digit' });
    const li = `<li class="border-bottom py-1 d-flex justify-content-between"><span>${icon} ${msg}</span><span class="text-muted">${time}</span></li>`;
    activityLog.insertAdjacentHTML('afterbegin', li);
  }

  clockInBtn.addEventListener('click', () => {
    if (!isWithinZone) return showModal('Fuera de zona', 'Debes estar dentro de la zona de trabajo.');
    statusIndicator.textContent = 'Estado: Trabajando üíº';
    statusIndicator.classList.replace('bg-light', 'bg-success');
    statusIndicator.classList.add('text-white');
    logActivity('Entrada registrada manualmente', '‚úÖ');
    clockInBtn.disabled = true;
  });

  function toRad(x){return x*Math.PI/180;}
  function distance(a,b){
    const R=6371e3,dLat=toRad(b.lat-a.lat),dLon=toRad(b.lon-a.lon);
    const c=2*Math.atan2(Math.sqrt(Math.sin(dLat/2)**2+Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLon/2)**2),Math.sqrt(1-Math.sin(dLat/2)**2));
    return R*c;
  }
  
  if (navigator.geolocation) {
    navigator.geolocation.watchPosition(pos => {
      const coords = { lat: pos.coords.latitude, lon: pos.coords.longitude };
      const d = distance(officeCoords, coords);
      isWithinZone = d <= workRadius;
      if (!userMarker) userMarker = L.marker([coords.lat, coords.lon]).addTo(map);
      else userMarker.setLatLng([coords.lat, coords.lon]);
      locationStatus.innerHTML = isWithinZone ? `Dentro de la zona (${Math.round(d)} m) ‚úÖ` : `Fuera de la zona (${(d/1000).toFixed(2)} km) üòÖ`;
    }, err => showModal('Error GPS', err.message), { enableHighAccuracy: true });
  } else showModal('Error', 'Tu navegador no soporta geolocalizaci√≥n.');
});
</script>
</body>
</html>