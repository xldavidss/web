<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard de Administrador</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <style>
    body { background-color: #f8f9fa; font-family: 'Inter', sans-serif; }
    .navbar { background-color: #212529; }
    .card { border: none; border-radius: 0.75rem; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
    .table-hover tbody tr:hover { background-color: #f1f3f5; cursor: pointer; }
    .icon-square {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        width: 3rem;
        height: 3rem;
        font-size: 1.5rem;
        border-radius: 0.75rem;
    }
    .modal-content { border-radius: 1rem; }
  </style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark shadow-sm">
  <div class="container-fluid">
    <a class="navbar-brand d-flex align-items-center" href="#">
      <i class="bi bi-shield-lock-fill me-2"></i> Panel de Administrador
    </a>
    <div class="ms-auto d-flex align-items-center">
      <span id="user-name" class="navbar-text me-3 fw-semibold d-none d-sm-block">Cargando...</span>
      <img id="user-photo" src="https://placehold.co/40x40/343a40/FFFFFF?text=A" alt="Foto" class="rounded-circle border border-secondary me-3" width="40" height="40">
      <button id="logout-btn" class="btn btn-outline-light btn-sm">Cerrar Sesión</button>
    </div>
  </div>
</nav>

<main class="container-fluid mt-4">
  <div class="row g-4">

    <div class="col-lg-4">
      <div class="card p-3 mb-4">
        <div class="card-body">
            <h5 class="card-title fw-bold mb-4">Estadísticas Generales</h5>
            <div class="row g-3">
                <div class="col-12 d-flex align-items-center">
                    <div class="icon-square bg-primary text-white bg-opacity-75 me-3"><i class="bi bi-journal-text"></i></div>
                    <div>
                        <h6 class="mb-0 text-muted">Total de Reportes</h6>
                        <h4 id="stats-total-reports" class="fw-bold mb-0">0</h4>
                    </div>
                </div>
                <div class="col-12 d-flex align-items-center">
                    <div class="icon-square bg-success text-white bg-opacity-75 me-3"><i class="bi bi-people-fill"></i></div>
                    <div>
                        <h6 class="mb-0 text-muted">Empleados Activos</h6>
                        <h4 id="stats-total-users" class="fw-bold mb-0">0</h4>
                    </div>
                </div>
            </div>
        </div>
      </div>
      <div class="card p-3">
        <div class="card-body">
          <h5 class="card-title fw-bold mb-3">Reportes en los Últimos 7 Días</h5>
          <canvas id="reportsChart"></canvas>
        </div>
      </div>
    </div>

    <div class="col-lg-8">
      <div class="card">
        <div class="card-body">
          <h5 class="card-title fw-bold mb-3">Últimos Reportes Recibidos</h5>
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light">
                <tr>
                  <th scope="col"># Reporte</th>
                  <th scope="col">Empleado</th>
                  <th scope="col">Fecha</th>
                  <th scope="col">Acciones</th>
                </tr>
              </thead>
              <tbody id="reports-table-body">
                </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<div class="modal fade" id="reportDetailsModal" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header border-0">
        <h5 class="modal-title fw-bold" id="modal-title">Detalles del Reporte</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p><strong>Empleado:</strong> <span id="modal-user-name"></span></p>
        <p><strong>Fecha:</strong> <span id="modal-report-date"></span></p>
        <h6 class="fw-semibold mt-4">Descripción:</h6>
        <p id="modal-report-text" class="bg-light p-3 rounded"></p>
        <h6 class="fw-semibold mt-4">Imágenes Adjuntas:</h6>
        <div id="modal-images-container" class="d-flex flex-wrap gap-2">
          </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', async () => {
    const API_URL = 'http://localhost:3000';
    const token = localStorage.getItem('authToken');

    // 1. Verificación de Autenticación y Rol
    if (!token) {
        window.location.href = './logueo.html';
        return;
    }
    
    const fetchWithAuth = (url, options = {}) => {
        const headers = {
            ...options.headers,
            'Authorization': `Bearer ${token}`
        };
        return fetch(url, { ...options, headers });
    };

    try {
        const userRes = await fetchWithAuth(`${API_URL}/api/user`);
        if (!userRes.ok) throw new Error('Sesión inválida');
        const user = await userRes.json();
        
        if (user.role !== 'administrador') {
            alert('Acceso denegado. Debes ser administrador.');
            window.location.href = './dashboard_empleado.html';
            return;
        }
        
        document.getElementById('user-name').textContent = user.name;
        if (user.avatar_url) {
            document.getElementById('user-photo').src = `${API_URL}${user.avatar_url}`;
        }
    } catch (e) {
        localStorage.removeItem('authToken');
        window.location.href = './logueo.html';
        return;
    }

    // Elementos del DOM
    const reportsTableBody = document.getElementById('reports-table-body');
    const reportModal = new bootstrap.Modal(document.getElementById('reportDetailsModal'));

    // 2. Cargar Estadísticas y Gráfico
    const loadStats = async () => {
        try {
            const res = await fetchWithAuth(`${API_URL}/api/admin/stats`);
            const stats = await res.json();
            
            document.getElementById('stats-total-reports').textContent = stats.totalReports;
            document.getElementById('stats-total-users').textContent = stats.totalUsers;

            // Configuración del Gráfico
            const ctx = document.getElementById('reportsChart').getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: stats.reportsByDay.map(d => new Date(d.date).toLocaleDateString('es-CO', { month: 'short', day: 'numeric' })),
                    datasets: [{
                        label: 'Nº de Reportes',
                        data: stats.reportsByDay.map(d => d.totalReports),
                        backgroundColor: 'rgba(13, 110, 253, 0.6)',
                        borderColor: 'rgba(13, 110, 253, 1)',
                        borderWidth: 1,
                        borderRadius: 5
                    }]
                },
                options: { scales: { y: { beginAtZero: true, ticks: { precision: 0 } } } }
            });
        } catch (error) {
            console.error('Error al cargar estadísticas:', error);
        }
    };
    
    // 3. Cargar Tabla de Reportes
    const loadReports = async () => {
        try {
            const res = await fetchWithAuth(`${API_URL}/api/reports`);
            const reports = await res.json();
            
            if (reports.length === 0) {
                reportsTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No hay reportes para mostrar.</td></tr>';
                return;
            }

            reportsTableBody.innerHTML = reports.map(report => `
                <tr>
                    <td class="fw-bold">#${report.id}</td>
                    <td>${report.userName}</td>
                    <td>${new Date(report.created_at).toLocaleString('es-CO')}</td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary view-details-btn" data-id="${report.id}" title="Ver Detalles">
                            <i class="bi bi-eye-fill"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-secondary download-pdf-btn" data-id="${report.id}" title="Descargar PDF">
                            <i class="bi bi-file-earmark-pdf-fill"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('Error al cargar reportes:', error);
            reportsTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Error al cargar los reportes.</td></tr>';
        }
    };
    
    // 4. Lógica de Eventos para los botones
    reportsTableBody.addEventListener('click', async (e) => {
        const button = e.target.closest('button');
        if (!button) return;
        
        const reportId = button.dataset.id;

        // Ver Detalles
        if (button.classList.contains('view-details-btn')) {
            const res = await fetchWithAuth(`${API_URL}/api/reports/${reportId}`);
            const data = await res.json();
            
            document.getElementById('modal-title').textContent = `Detalles del Reporte #${reportId}`;
            document.getElementById('modal-user-name').textContent = data.userName;
            document.getElementById('modal-report-date').textContent = new Date(data.created_at).toLocaleString('es-CO');
            document.getElementById('modal-report-text').textContent = data.report_text;
            
            const imagesContainer = document.getElementById('modal-images-container');
            if (data.images && data.images.length > 0) {
                imagesContainer.innerHTML = data.images.map(imgUrl => 
                    `<a href="${API_URL}${imgUrl}" target="_blank"><img src="${API_URL}${imgUrl}" class="img-thumbnail" style="width:100px; height:100px; object-fit: cover;"></a>`
                ).join('');
            } else {
                imagesContainer.innerHTML = '<p class="text-muted fst-italic">No hay imágenes adjuntas.</p>';
            }
            reportModal.show();
        }

        // Descargar PDF
        if (button.classList.contains('download-pdf-btn')) {
            try {
                button.disabled = true;
                const res = await fetchWithAuth(`${API_URL}/api/reports/${reportId}/pdf`);
                if (!res.ok) throw new Error('No se pudo generar el PDF.');
                
                const blob = await res.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.style.display = 'none';
                a.href = url;
                a.download = `reporte-${reportId}.pdf`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                a.remove();
            } catch (error) {
                alert(error.message);
            } finally {
                button.disabled = false;
            }
        }
    });

    // 5. Cierre de sesión
    document.getElementById('logout-btn').addEventListener('click', () => {
        localStorage.removeItem('authToken');
        window.location.href = './logueo.html';
    });
    
    // Carga inicial de datos
    loadStats();
    loadReports();
});
</script>
</body>
</html>